{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "RolesStack": {
      "Type": "String",
      "Description": "Stack for Roles and Policies and Artefact Bucket."
    }
  },
  "Resources": {
    
    "CodeBuildProject" : {
      "Type": "AWS::CodeBuild::Project",
      "Properties": {
        "Artifacts": {
          "Type": "CODEPIPELINE"
        },
        "Source": {
          "Type": "CODEPIPELINE",
          "BuildSpec": "buildspec.yml"
        },
        "Environment": {
          "ComputeType": "BUILD_GENERAL1_SMALL",
          "Image": "aws/codebuild/docker:17.09.0",
          "Type": "LINUX_CONTAINER"
        },
        "Name": "CodeBuildProject",
        "ServiceRole": {"Fn::ImportValue" :  {"Fn::Sub": "${RolesStack}-ServiceRoleForCodeBuild"}},
        "LogsConfig": {
          "CloudWatchLogs": {
            "Status": "ENABLED",
            "GroupName": {"Fn::ImportValue" :  {"Fn::Sub": "${RolesStack}-SimpleAWSPipelineLogs"}}
          }
        }
      }
    },
    
    "CodeDeployApplication" : {
      "Type": "AWS::CodeDeploy::Application"
    },
    "CodeDeployGroup": {
      "Type": "AWS::CodeDeploy::DeploymentGroup",
      "Properties": {
        "ApplicationName": {
          "Ref": "CodeDeployApplication"
        },
        "ServiceRoleArn": {"Fn::ImportValue" :  {"Fn::Sub": "${RolesStack}-ServiceRoleForCodeDeploy"}}
      }
    },
    
    "AppPipeline": {
      "Type": "AWS::CodePipeline::Pipeline",
      "Properties": {
        "RoleArn": {"Fn::ImportValue" :  {"Fn::Sub": "${RolesStack}-ServiceRoleForCodePipeline"}},
        "Stages": [
          {
            "Name": "Source",
            "Actions": [
              {
                "Name": "SourceAction",
                "InputArtifacts": [],
                "ActionTypeId": {
                  "Category": "Source",
                  "Owner": "AWS",
                  "Version": "1",
                  "Provider": "CodeStarSourceConnection"
                },
                "Configuration": {
                  "ConnectionArn": "arn:aws:codestar-connections:eu-west-2:780487234683:connection/43c0aecd-9e08-4eba-83b6-2b2131d809fb",
                  "FullRepositoryId": "kufena/SimpleAWSTest5.0",
                  "BranchName": "main",
                  "OutputArtifactFormat": "CODE_ZIP"
                },
                "OutputArtifacts": [
                  {
                    "Name": "PrimarySourceOutput"
                  }
                ],
                "RunOrder": 1
              }
            ]
          },
          {
            "Name": "Build",
            "ActionTypeId": {
              "Category": "Build",
              "Owner": "AWS",
              "Version": "1",
              "Provider": "CodeBuild"
            },
            "RunOrder": 2,
            "Configuration": {
              "BatchEnabled": "true",
              "CombineArtifacts": "true",
              "ProjectName": "my-build-project",
              "PrimarySource": "PrimarySourceOutput"
            },
            "OutputArtifacts": [
              {
                "Name": "PrimaryBuildOutput"
              }
            ],
            "InputArtifacts": [
              {
                "Name": "PrimarySourceOutput"
              }
            ]
          },
          {
            "Name": "Deploy",
            "ActionTypeId": {
              "Category": "Deploy",
              "Owner": "AWS",
              "Version": "1",
              "Provider": "CodeDeploy"
            },
            "RunOrder": 3,
            "Configuration": {
              "AppicationName": {"Ref": "CodeDeployApplication"},
              "DeploymentConfiguration": {"Ref": "CodeDeployGroup"}
            },
            "InputArtifacts": [{
              "Name": "PrimaryBuildOutput"
            }]
          }
        ],
        
        "ArtifactStore": {
          "Type": "S3",
          "Location": {
            "Ref": "ArtifactStoreS3Location"
          }
        }
      }
    }
  }